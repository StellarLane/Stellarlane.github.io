---
title: Machine Learning Notes 3
category: CSDIY
tags:
  - Machine Learning
  - python
  - Data Science
date: 2024-07-23
summary: ç§‘æ™®è§†é¢‘çº§åˆ«çš„æœºå™¨å­¦ä¹ ï¼šSelf-attention and transformer.
---

## Self-attention

è‡ªæ³¨æ„åŠ›æœºåˆ¶è¯ç”Ÿçš„ç›®çš„åœ¨äºå®ç°åœ¨ä»¥sequenceä½œä¸ºè¾“å…¥æ—¶åŒæ—¶è€ƒè™‘è¿™ä¸ªsequenceé‡Œçš„æ‰€æœ‰è¾“å…¥
![](https://ooo.0x0.ooo/2024/07/24/ORLrRa.png)
[å›¾æº](https://youtu.be/hYdO9CscNes?si=hvt0KbqT4Xe4C0ZF)
ç®€å•æ¥è¯´ï¼Œå…¶ç›®çš„å³ä¸ºæ‰¾åˆ°ä¸åŒçš„inputä¹‹é—´çš„ç›¸å…³æ€§ï¼Œä»æ¯ä¸ªè¾“å…¥çš„è§’åº¦æ¥çœ‹ï¼Œå…¶å…ˆå°†é€‰å®šè¾“å…¥å‘é‡ç‚¹ä¹˜ä¸€ä¸ªqå‘é‡ï¼ˆqueryï¼‰ï¼Œå†å°†æ‰€æœ‰è¾“å…¥å‘é‡ä¹˜ä»¥ä¸€ä¸ªkå‘é‡ï¼ˆkeyï¼‰ï¼Œåœ¨åˆ†åˆ«å°†ä¹˜ç‚¹ä¹˜ï¼Œå¾—åˆ°æ­¤å‘é‡ä¸åˆ«çš„å‘é‡ä¹‹é—´çš„å…³è”ã€‚æœ€åæˆ‘ä»¬å†åˆ†åˆ«å°†å„ä¸ªå‘é‡ä¸ä¸€ä¸ªvå‘é‡ç›¸ä¹˜ï¼ˆvalueï¼‰å¾—åˆ°æœ€åçš„è¾“å‡ºã€‚
é‚£ä¹ˆæˆ‘ä»¬ä»çº¿æ€§ä»£æ•°çš„è§’åº¦æ¥æè¿°ä¸€ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ï¼Œå‡è®¾æœ‰ä¸€ä¸ªm\*nçš„è¾“å…¥çŸ©é˜µIï¼ˆæ¯ä¸€åˆ—ä¸ºä¸€ä¸ªè¾“å…¥å…±nä¸ªï¼‰ï¼Œé‚£ä¹ˆåˆ™æœ‰ä¸‰ä¸ªå‡ä¸ºm\*mçš„æŸ¥è¯¢çŸ©é˜µW^q^, W^k^ï¼ŒW^v^ï¼Œéšåæˆ‘ä»¬å°±å¯ä»¥ç›¸ä¹˜è·å¾—çŸ©é˜µQï¼ŒKï¼ŒV=W^q^\*X, W^k^\*X, W^v^\*Xï¼ˆm\*nï¼‰ï¼Œè€Œåå¾—åˆ°æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µA=K^T^\*Qï¼ˆn\*nï¼‰ï¼Œæœ€åå¾—åˆ°è¾“å‡ºO=V\*A(m\*n)
äº‹å®ä¸Šè¿™é‡Œå¯ä»¥ä¼˜åŒ–ä¸€ä¸‹è¿ç®—é‡ï¼Œå³æœ€ç»ˆè¾“å‡ºä¸ºO=V\*K^T^\*Qæ­¤å¤„å¯ä»¥å°†å‰ä¸¤é¡¹ç›¸ä¹˜ï¼Œå¯ä»¥èŠ‚çº¦éƒ¨åˆ†è¿ç®—é‡ã€‚

### multi-head Self-attention

è‹¥åªè€ƒè™‘â€œä¸€ç§ç›¸å…³æ€§â€è¿˜ä¸å¤Ÿçš„è¯ï¼Œä¸å¦¨è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨å¤šå¤´çš„æœºåˆ¶ï¼Œå³è®¾å®šæœ‰å¤šä¸ªW^q^, W^k^, W^v^çŸ©é˜µï¼Œæœ€åå¾—åˆ°å¤šä¸ªOå†ä¹˜ä¸€ä¸ªæ–°çš„W^O^å˜æ¢çŸ©é˜µå¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºã€‚

### positional encoding

åœ¨åŸå§‹çš„è‡ªæ³¨æ„ç³»ç»Ÿä¸­ï¼Œè™½ç„¶å¯ä»¥å¯»æ‰¾ä¸åŒè¾“å…¥ä¹‹é—´çš„å…³è”ï¼Œä½†å¹¶ä¸èƒ½å¯Ÿè§‰ä¸åŒè¾“å…¥çš„ä½ç½®å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åŠ å…¥positional encodingï¼Œæœ€ç®€å•çš„ä¸€ç§å®ç°æ–¹å¼å°±æ˜¯åœ¨è¾“å…¥çŸ©é˜µè¾“å…¥å‰åŠ ä¸€ä¸ªå¯ä»¥è¡¨ç¤ºä½ç½®çš„çŸ©é˜µï¼ˆæ¯”å¦‚ `np.diag([0,1,2,3,4...])`ï¼‰

## Transformer

Transformeræ˜¯ä¸€ç§å¹¿æ³›é‡‡ç”¨çš„sequence to sequenceï¼ˆseq2seqï¼‰çš„æ¨¡å‹ï¼Œå³è¾“å…¥çš„é•¿åº¦ä¸è¾“å‡ºçš„é•¿åº¦éƒ½ä¸å®šï¼Œè¿™ç±»æ¨¡å‹åœ¨å¦‚ç¿»è¯‘ç­‰æ–¹é¢æœ‰ç€éå¸¸å¹¿æ³›çš„åº”ç”¨ï¼ˆç¿»è¯‘åçš„æ–‡å­—é•¿åº¦ä¸å®šï¼‰ã€‚ä¹Ÿæ˜¯å¤§è¯­è¨€æ¨¡å‹çš„é‡è¦åŸºç¡€ã€‚
![](https://ooo.0x0.ooo/2024/07/24/ORLA9S.png)
[å›¾æº](https://arxiv.org/pdf/1706.03762)
transformerçš„æ¶æ„è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œencoderï¼ˆå·¦ï¼‰å’Œdecoderï¼ˆå³ï¼‰

### Encoder> reference

> [æå®æ¯…æœºå™¨å­¦ä¹ ](https://speech.ee.ntu.edu.tw/~hylee/ml/2022-spring.php)

åœ¨è¾“å…¥è¿›è¡Œembeddingå’Œpositional encodingä¹‹åï¼Œå…ˆè¿›å…¥ä¸€ä¸ªmulti-head attentionå±‚ï¼Œç„¶ååœ¨Add&Normå±‚åŠ ä¸ŠåŸè¾“å…¥ï¼ˆæ®‹å·®è®¾è®¡ï¼‰å’Œè¿›è¡ŒNormalizationï¼Œå†è¿›å…¥ä¸€ä¸ªFeed Fowardå±‚ï¼ˆå…¨è¿æ¥å±‚ï¼‰å†è¿›è¡Œä¸€æ¬¡Add&Normï¼ˆè¿™ä¸€æ•´ä¸ªæµç¨‹å¯ä»¥é‡å¤å¤šæ¬¡ï¼‰

### Decoder

æˆ‘ä»¬å¯ä»¥å‘ç°decoderçš„è¾“å…¥å’Œè¾“å‡ºæ˜¯åŒä¸€å½¢çŠ¶çš„ï¼Œæ‰€ä»¥transformerè¦å®ç°ä¸å®šé•¿åº¦çš„è¾“å‡ºä¸»è¦ä¾é ååŠéƒ¨åˆ†çš„decoderã€‚æˆ‘ä»¬çŸ¥é“å…¶æœ¬èº«å°±æ˜¯ç”Ÿæˆä¸€ç³»åˆ—å­—ç¬¦ï¼Œé‚£ä¹ˆè§£å†³åŠæ³•å°±æ˜¯å°†ä¼‘æ­¢ç¬¦ä¹ŸåŠ å…¥å¥–æ± å½“ä¸­ï¼Œä»€ä¹ˆæ—¶å€™æŠ½åˆ°ENDä»€ä¹ˆæ—¶å€™ç»“æŸã€‚
é‚£ä¹ˆå…¶ç”Ÿæˆæ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ï¼ŒATï¼ˆautoregressiveï¼‰å’Œ NATï¼ˆnon-autoregressiveï¼‰ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸€æ­¥ä¸€æ­¥æ…¢æ…¢æ¥çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€éƒ¨decoderå…ˆåƒä¸€ä¸ªstartï¼Œç„¶åè¿›è¡Œä¸€æ¬¡è¾“å‡ºï¼Œå†å°†è¿™ä¸ªè¾“å…¥é‡æ–°å–‚è¿›æ¨¡å‹ï¼Œå†è¿‡ä¸€æ¬¡æ¨¡å‹ï¼Œå¦‚æ­¤å¾€å¤ç›´åˆ°è¾“å‡ºç»“æœä¸ºENDã€‚
é‚£ä¹ˆNon-autoregressiveåˆ™æ˜¯è¯•å›¾ä¸€æ­¥åˆ°ä½çš„å°è¯•ï¼Œé‚£ä¹ˆå¦‚ä½•åšåˆ°ä¸€æ­¥åˆ°ä½å‘¢ï¼Œæ¯”è¾ƒç®€å•çš„æ–¹æ³•ä¸€ä¸ªæ˜¯å•ç‹¬å†è®­ç»ƒä¸€ä¸ªclassifieræ¥å†³å®šç»“æœçš„é•¿åº¦ï¼Œæˆ–è€…æ‰€å¹¸ä¸€æ¬¡æ€§å‘é‡Œé¢æ‰”è¶³å¤Ÿé•¿çš„è¾“å…¥å€¼ï¼Œç„¶åçœ‹å“ªä¸€ä½ç”Ÿæˆäº†ENDï¼Œç„¶åç›´æ¥å–ENDå‰çš„ä½œä¸ºæœ€ç»ˆè¾“å‡ºã€‚
å¦‚ä¸Šæˆ‘ä»¬å¯ä»¥å‘ç°NATåœ¨å‡†ç¡®æ€§ä¸Šæ˜¾ç„¶è¿œè¿œä¸å¦‚ATï¼Œä¸è¿‡ç”±äºå…¶æœ‰é€Ÿåº¦å¿«ç­‰ç‰¹æ€§ï¼Œå› æ­¤ä¼˜åŒ–å…¶è®­ç»ƒå‡†ç¡®åº¦ä¹Ÿæ˜¯ç ”ç©¶çš„çƒ­é—¨æ–¹å‘ä¹‹ä¸€

#### Masked Multi-Head Attention

å…ˆå‰æˆ‘ä»¬è®¾è®¡çš„Self-attentionéƒ¨åˆ†æ˜¯ä¸€æ¬¡æ€§è€ƒè™‘æ•´ä¸ªè¾“å‡ºçš„å†…å®¹ï¼Œè€Œåœ¨Decoderé˜¶æ®µçš„åƒä¸€ä¸ªåä¸€ä¸ªçš„æƒ…å†µä¸‹ï¼Œâ€œè€ƒè™‘æ•´æ®µâ€æ˜¾ç„¶æ˜¯ä¸ªæ²¡æœ‰æ„ä¹‰çš„æƒ…å†µï¼Œæ­¤å¤„çš„maskedçš„æ•ˆæœå³æ˜¯ï¼Œåœ¨è®¡ç®—attention matrixçš„æ—¶å€™åªè€ƒè™‘è‡ªèº«ä¸è‡ªèº«ä¹‹å‰çš„è¾“å…¥åºåˆ—ï¼Œä¸è€ƒè™‘ä¹‹åçš„è¾“å‡ºåºåˆ—ã€‚

#### cross-attention

åœ¨decoderç¬¬äºŒé˜¶æ®µï¼Œå°†encoderè¾“å‡ºå’Œdecoderç¬¬ä¸€é˜¶æ®µè¾“å‡ºåŒæ—¶è¾“å…¥ä¸€ä¸ªmasked multi-head attentionå±‚ä¸­ï¼Œä¹Ÿå°±æ˜¯ç®—decoderè¾“å‡ºå’Œencoderè¾“å‡ºçš„ç›¸å…³æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠä»–å°±å«åšcross-attention
![](https://ooo.0x0.ooo/2024/07/25/ORSogD.png)
[å›¾æº](https://speech.ee.ntu.edu.tw/~hylee/ml/ml2021-course-data/seq2seq_v9.pdf)

### è®­ç»ƒæ–¹æ³•ä¸æ›´å¤šæ‹“å±•

- Teacher Forcingï¼šåœ¨ATçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¾“å‡ºä¸ä¸Šä¸€ä¸ªè¾“å‡ºä¹‹é—´æœ‰å¾ˆå¼ºçš„å…³è”ï¼Œè‹¥ä¸Šä¸€ä¸ªè¾“å‡ºå‡ºé—®é¢˜ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªè¾“å‡ºä¹Ÿå¤§æ¦‚ç‡ä¸‹ä¼šå¯„ï¼Œè‹¥è®­ç»ƒæ—¶ä¸åŠ å¹²æ¶‰ä»»å…¶ä¸€é”™å†é”™ï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´è®­ç»ƒæ•ˆç‡è¾ƒå·®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨è®­ç»ƒçš„æ—¶å€™å§‹ç»ˆä¼ å…¥æ­£ç¡®çš„è¾“å…¥ï¼Œé™ä½å‘ç”Ÿè¿é”é”™è¯¯çš„æ¦‚ç‡ï¼Œä¼˜åŒ–è®­ç»ƒæ–¹å¼ã€‚
- Schedule Samplingï¼šä¸è¿‡Teacher Forcingçš„æ–¹æ³•è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œè‹¥æ¨¡å‹åœ¨æµ‹è¯•çš„æ—¶å€™ä¸€ç›´éƒ½ç”¨çš„æ˜¯æ­£ç¡®çš„ç­”æ¡ˆä½œä¸ºè¾“å…¥ï¼Œé‚£åœ¨æµ‹è¯•çš„æ—¶å€™è¿˜æ˜¯ä¸€æ—¦é”™äº†å°±åºŸäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆä¸èƒ½ä¸€ç›´è¾“å…¥æ­£ç¡®ç­”æ¡ˆï¼Œä¹Ÿè¦åœ¨è®­ç»ƒçš„æ—¶å€™äººå·¥åŠ å…¥ä¸€äº›é”™è¯¯ç­”æ¡ˆï¼Œä¹Ÿå°±æ˜¯Schedule Sampling ~~æ°´å¤šåŠ é¢é¢å¤šåŠ æ°´çš„æ„Ÿè§‰~~
- Guided Attentionï¼šåŸå§‹çš„Attentionçš„ç»“æ„ä¸­ï¼Œæ¨¡å‹ä¼šå¹³ç­‰åœ°çœ‹å¾…åºåˆ—ä¸­æ¯ä¸€ä»½è¾“å…¥ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œåœ¨æŸäº›æ¡ä»¶ä¸‹æˆ‘ä»¬å¯èƒ½æ›´éœ€è¦æ¨¡å‹å»ç‰¹å®šåœ°å…³æ³¨æŸä¸€éƒ¨åˆ†çš„ç›¸å…³æ€§ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å¼•å…¥é¢å¤–çš„æƒé‡ç­‰æ–¹å¼æ¥äººä¸ºå¹²é¢„attention scoreçš„äº§ç”Ÿã€‚
- Beam Searchï¼šå‡è®¾è¾“å‡ºæ˜¯ä¸€æ®µä¸­æ–‡æ–‡å­—ï¼ˆæ¯”å¦‚ç¿»è¯‘ä»»åŠ¡ï¼Œæˆ–è€…å¤§è¯­è¨€æ¨¡å‹ï¼‰ï¼Œæ¯æ¬¡è¾“å‡ºéƒ½æ˜¯ä»å­—ç¬¦åº“é‡Œé€‰å‡ºé‚£ä¸ªæ¦‚ç‡æœ€å¤§çš„å¯èƒ½æ€§ï¼Œé‚£ä¹ˆä¸éš¾å‘ç°æˆ‘ä»¬çš„è¾“å‡ºå®é™…ä¸Šæ˜¯ä¸€ä¸ªåˆ†ç±»é—®é¢˜ï¼Œåªæ˜¯è¿™ä¸ªåˆ†ç±»çš„å¤‡é€‰ç§ç±»æœ‰ç‚¹ç‚¹å¤šï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½è¦ç©·ä¸¾æ‰€æœ‰çš„åˆ†ç±»ç»„åˆæ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œä½†æ˜¯è‹¥æ˜¯è´ªå¿ƒç®—æ³•æœ‰å¯èƒ½é¢ä¸´å±€éƒ¨æœ€ä½³å¹¶éå…¨å±€æœ€ä½³çš„æƒ…å†µï¼Œå› æ­¤åœ¨äºŒè€…ä¹‹é—´å°±å¼€å‘äº†ä¸€ä¸ªæŠ˜è¡·çš„Beam Searchçš„ç®—æ³•ï¼Œå…¶å®ä¹Ÿè¿˜æ˜¯è´ªå¿ƒï¼Œåªæ˜¯æ¯æ¬¡ä¸åªæ˜¯ä¿ç•™æœ€é«˜çš„å¾—åˆ†çš„é‚£ä¸ªï¼Œè€Œæ˜¯ä¿ç•™æ•°ä¸ªè¾ƒé«˜çš„å¾—åˆ†ï¼Œå…¼é¡¾äº†è´ªå¿ƒç®—æ³•çš„é€Ÿåº¦å’Œç©·ä¸¾çš„å‡†ç¡®æ€§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡å¦‚Length Penaltyç­‰æ–¹å¼è®¤ä¸ºæ§åˆ¶beam searchçš„ç»†èŠ‚ã€‚
- å„å¼å„æ ·çš„attentionï¼šç”±å‰é¢æˆ‘ä»¬ä¸éš¾çŸ¥é“attentionä¸­æœ€å¤§çš„ç“¶é¢ˆå°±åœ¨attention matrixçš„è®¡ç®—ä¸Šï¼ˆn^2^ï¼‰ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½æƒ³åŠæ³•ä¼˜åŒ–è¿™éƒ¨åˆ†å‘¢ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯åªè®¡ç®—ä¸€éƒ¨åˆ†é‡è¦çš„attention scoreå°±å¯ä»¥äº†ï¼Œé‚£ä¹ˆæ€ä¹ˆç•Œå®šä¸€ä¸ªattention scoreé‡ä¸é‡è¦å‘¢ï¼Œä¸€ç§æ–¹æ³•å°±æ˜¯äººä¸ºåˆ¶å®šå“ªäº›éœ€è¦è®¡ç®—å“ªäº›ä¸éœ€è¦è®¡ç®—ï¼ˆæ¯”å¦‚å¯ä»¥è§„å®šåªè€ƒè™‘ä¸€ä¸ªè¾“å…¥å’Œå…¶å‰åæœ‰é™é¡¹çš„å…³è”ç¨‹åº¦ï¼Œå³local attentionï¼Œå½“ç„¶è¿™ä¸ªçš„å®è´¨å’ŒCNNå°±å·®ä¸å¤šäº†ğŸ¤£ï¼‰ç­‰ç­‰ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥åˆ©ç”¨å¦‚èšç±»åˆ†æç­‰æ–¹æ³•å°†ä¸€ä¸ªå†³å®šå“ªäº›attention scoreéœ€è¦è®¡ç®—è¿™ä»¶äº‹æœ¬èº«ä¹Ÿä½œä¸ºæ¨¡å‹çš„ä¸€éƒ¨åˆ†ã€‚

> Reference
>
> [æå®æ¯…æœºå™¨å­¦ä¹ ](https://speech.ee.ntu.edu.tw/~hylee/ml/2022-spring.php)
